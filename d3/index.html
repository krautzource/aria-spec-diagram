<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ARIA Spec diagrams using D3</title>
    <style>
      .node circle {
        fill: #999;
      }

      .node text {
        font: 10px sans-serif;
      }

      .node--internal circle {
        fill: #555;
      }

      .node--internal text {
        text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
      }

      .link {
        fill: none;
        stroke: #555;
        stroke-opacity: 0.4;
        stroke-width: 1.5px;
      }

      label {
        display: block;
      }

      .is-activedescendant circle {
        fill: pink;
      }
      .is-activedescendant text {
        text-shadow: 0 1px 0 pink, 0 -1px 0 pink, 1px 0 0 pink, -1px 0 0 pink;
      }
    </style>
  </head>
  <body>
    <h1>ARIA role class diagram</h1>
    <p>
      Use the controls below to switch between tidy-tree and Dendogram layout of
      the D3 output.
    </p>
    <form>
      <label
        ><input type="radio" name="mode" value="tree" checked /> Tree</label
      >
      <label
        ><input type="radio" name="mode" value="cluster" /> Dendrogram</label
      >
    </form>
    <svg
      tabindex="0"
      role="tree"
      aria-label="ARIA Spec class diagram"
      aria-description="Focus to navigate with arrow keys."
      width="960"
      height="2400"
    ></svg>
    <script src="./treewalker.js"></script>
    <script src="./d3.min.js"></script>
    <script>
      const data =
      {"name":"roletype","id":"roletype","children":[{"name":"structure","id":"roletypestructure","children":[{"name":"application","id":"roletypestructureapplication","children":[],"level":3,"position":0,"setsize":9,"posinset":1},{"name":"document","id":"roletypestructuredocument","children":[{"name":"article","id":"roletypestructuredocumentarticle","children":[{"name":"comment","id":"roletypestructuredocumentarticlecomment","children":[],"level":5,"position":0,"setsize":1,"posinset":1}],"level":4,"position":0,"setsize":1,"posinset":1}],"level":3,"position":0,"setsize":9,"posinset":2},{"name":"generic","id":"roletypestructuregeneric","children":[],"level":3,"position":0,"setsize":9,"posinset":3},{"name":"presentation","id":"roletypestructurepresentation","children":[],"level":3,"position":0,"setsize":9,"posinset":4},{"name":"range","id":"roletypestructurerange","children":[{"name":"meter","id":"roletypestructurerangemeter","children":[],"level":4,"position":0,"setsize":5,"posinset":1},{"name":"progressbar (*)","id":"roletypestructurerangeprogressbar","children":[],"level":4,"position":0,"setsize":5,"posinset":2},{"name":"scrollbar (*)","id":"roletypestructurerangescrollbar","children":[],"level":4,"position":0,"setsize":5,"posinset":3},{"name":"slider (*)","id":"roletypestructurerangeslider","children":[],"level":4,"position":0,"setsize":5,"posinset":4},{"name":"spinbutton (*)","id":"roletypestructurerangespinbutton","children":[],"level":4,"position":0,"setsize":5,"posinset":5}],"level":3,"position":0,"setsize":9,"posinset":5},{"name":"rowgroup","id":"roletypestructurerowgroup","children":[],"level":3,"position":0,"setsize":9,"posinset":6},{"name":"section","id":"roletypestructuresection","children":[{"name":"alert","id":"roletypestructuresectionalert","children":[{"name":"alertdialog (*)","id":"roletypestructuresectionalertalertdialog","children":[],"level":5,"position":0,"setsize":1,"posinset":1}],"level":4,"position":0,"setsize":36,"posinset":1},{"name":"associationlist","id":"roletypestructuresectionassociationlist","children":[],"level":4,"position":0,"setsize":36,"posinset":2},{"name":"associationlistitemkey","id":"roletypestructuresectionassociationlistitemkey","children":[],"level":4,"position":0,"setsize":36,"posinset":3},{"name":"associationlistitemvalue","id":"roletypestructuresectionassociationlistitemvalue","children":[],"level":4,"position":0,"setsize":36,"posinset":4},{"name":"blockquote","id":"roletypestructuresectionblockquote","children":[],"level":4,"position":0,"setsize":36,"posinset":5},{"name":"caption","id":"roletypestructuresectioncaption","children":[],"level":4,"position":0,"setsize":36,"posinset":6},{"name":"cell","id":"roletypestructuresectioncell","children":[{"name":"columnheader (*)","id":"roletypestructuresectioncellcolumnheader","children":[],"level":5,"position":0,"setsize":3,"posinset":1},{"name":"gridcell (*)","id":"roletypestructuresectioncellgridcell","children":[{"name":"columnheader (*)","id":"roletypestructuresectioncellgridcellcolumnheader","children":[],"level":6,"position":0,"setsize":2,"posinset":1},{"name":"rowheader (*)","id":"roletypestructuresectioncellgridcellrowheader","children":[],"level":6,"position":0,"setsize":2,"posinset":2}],"level":5,"position":0,"setsize":3,"posinset":2},{"name":"rowheader (*)","id":"roletypestructuresectioncellrowheader","children":[],"level":5,"position":0,"setsize":3,"posinset":3}],"level":4,"position":0,"setsize":36,"posinset":7},{"name":"code","id":"roletypestructuresectioncode","children":[],"level":4,"position":0,"setsize":36,"posinset":8},{"name":"definition","id":"roletypestructuresectiondefinition","children":[],"level":4,"position":0,"setsize":36,"posinset":9},{"name":"deletion","id":"roletypestructuresectiondeletion","children":[],"level":4,"position":0,"setsize":36,"posinset":10},{"name":"emphasis","id":"roletypestructuresectionemphasis","children":[],"level":4,"position":0,"setsize":36,"posinset":11},{"name":"figure","id":"roletypestructuresectionfigure","children":[],"level":4,"position":0,"setsize":36,"posinset":12},{"name":"group","id":"roletypestructuresectiongroup","children":[{"name":"row (*)","id":"roletypestructuresectiongrouprow","children":[],"level":5,"position":0,"setsize":3,"posinset":1},{"name":"select (*)","id":"roletypestructuresectiongroupselect","children":[{"name":"listbox","id":"roletypestructuresectiongroupselectlistbox","children":[],"level":6,"position":0,"setsize":4,"posinset":1},{"name":"menu","id":"roletypestructuresectiongroupselectmenu","children":[{"name":"menubar","id":"roletypestructuresectiongroupselectmenumenubar","children":[],"level":7,"position":0,"setsize":1,"posinset":1}],"level":6,"position":0,"setsize":4,"posinset":2},{"name":"radiogroup","id":"roletypestructuresectiongroupselectradiogroup","children":[],"level":6,"position":0,"setsize":4,"posinset":3},{"name":"tree","id":"roletypestructuresectiongroupselecttree","children":[{"name":"treegrid (*)","id":"roletypestructuresectiongroupselecttreetreegrid","children":[],"level":7,"position":0,"setsize":1,"posinset":1}],"level":6,"position":0,"setsize":4,"posinset":4}],"level":5,"position":0,"setsize":3,"posinset":2},{"name":"toolbar","id":"roletypestructuresectiongrouptoolbar","children":[],"level":5,"position":0,"setsize":3,"posinset":3}],"level":4,"position":0,"setsize":36,"posinset":13},{"name":"img","id":"roletypestructuresectionimg","children":[],"level":4,"position":0,"setsize":36,"posinset":14},{"name":"insertion","id":"roletypestructuresectioninsertion","children":[],"level":4,"position":0,"setsize":36,"posinset":15},{"name":"label","id":"roletypestructuresectionlabel","children":[],"level":4,"position":0,"setsize":36,"posinset":16},{"name":"landmark","id":"roletypestructuresectionlandmark","children":[{"name":"banner","id":"roletypestructuresectionlandmarkbanner","children":[],"level":5,"position":0,"setsize":8,"posinset":1},{"name":"complementary","id":"roletypestructuresectionlandmarkcomplementary","children":[],"level":5,"position":0,"setsize":8,"posinset":2},{"name":"contentinfo","id":"roletypestructuresectionlandmarkcontentinfo","children":[],"level":5,"position":0,"setsize":8,"posinset":3},{"name":"form","id":"roletypestructuresectionlandmarkform","children":[],"level":5,"position":0,"setsize":8,"posinset":4},{"name":"main","id":"roletypestructuresectionlandmarkmain","children":[],"level":5,"position":0,"setsize":8,"posinset":5},{"name":"navigation","id":"roletypestructuresectionlandmarknavigation","children":[],"level":5,"position":0,"setsize":8,"posinset":6},{"name":"region","id":"roletypestructuresectionlandmarkregion","children":[],"level":5,"position":0,"setsize":8,"posinset":7},{"name":"search","id":"roletypestructuresectionlandmarksearch","children":[],"level":5,"position":0,"setsize":8,"posinset":8}],"level":4,"position":0,"setsize":36,"posinset":17},{"name":"legend","id":"roletypestructuresectionlegend","children":[],"level":4,"position":0,"setsize":36,"posinset":18},{"name":"list","id":"roletypestructuresectionlist","children":[{"name":"directory","id":"roletypestructuresectionlistdirectory","children":[],"level":5,"position":0,"setsize":2,"posinset":1},{"name":"feed","id":"roletypestructuresectionlistfeed","children":[],"level":5,"position":0,"setsize":2,"posinset":2}],"level":4,"position":0,"setsize":36,"posinset":19},{"name":"listitem","id":"roletypestructuresectionlistitem","children":[{"name":"treeitem (*)","id":"roletypestructuresectionlistitemtreeitem","children":[],"level":5,"position":0,"setsize":1,"posinset":1}],"level":4,"position":0,"setsize":36,"posinset":20},{"name":"log","id":"roletypestructuresectionlog","children":[],"level":4,"position":0,"setsize":36,"posinset":21},{"name":"mark","id":"roletypestructuresectionmark","children":[],"level":4,"position":0,"setsize":36,"posinset":22},{"name":"marquee","id":"roletypestructuresectionmarquee","children":[],"level":4,"position":0,"setsize":36,"posinset":23},{"name":"math","id":"roletypestructuresectionmath","children":[],"level":4,"position":0,"setsize":36,"posinset":24},{"name":"note","id":"roletypestructuresectionnote","children":[],"level":4,"position":0,"setsize":36,"posinset":25},{"name":"paragraph","id":"roletypestructuresectionparagraph","children":[],"level":4,"position":0,"setsize":36,"posinset":26},{"name":"status","id":"roletypestructuresectionstatus","children":[{"name":"timer","id":"roletypestructuresectionstatustimer","children":[],"level":5,"position":0,"setsize":1,"posinset":1}],"level":4,"position":0,"setsize":36,"posinset":27},{"name":"strong","id":"roletypestructuresectionstrong","children":[],"level":4,"position":0,"setsize":36,"posinset":28},{"name":"subscript","id":"roletypestructuresectionsubscript","children":[],"level":4,"position":0,"setsize":36,"posinset":29},{"name":"suggestion","id":"roletypestructuresectionsuggestion","children":[],"level":4,"position":0,"setsize":36,"posinset":30},{"name":"superscript","id":"roletypestructuresectionsuperscript","children":[],"level":4,"position":0,"setsize":36,"posinset":31},{"name":"table","id":"roletypestructuresectiontable","children":[{"name":"grid (*)","id":"roletypestructuresectiontablegrid","children":[{"name":"treegrid (*)","id":"roletypestructuresectiontablegridtreegrid","children":[],"level":6,"position":0,"setsize":1,"posinset":1}],"level":5,"position":0,"setsize":1,"posinset":1}],"level":4,"position":0,"setsize":36,"posinset":32},{"name":"tabpanel","id":"roletypestructuresectiontabpanel","children":[],"level":4,"position":0,"setsize":36,"posinset":33},{"name":"term","id":"roletypestructuresectionterm","children":[],"level":4,"position":0,"setsize":36,"posinset":34},{"name":"time","id":"roletypestructuresectiontime","children":[],"level":4,"position":0,"setsize":36,"posinset":35},{"name":"tooltip","id":"roletypestructuresectiontooltip","children":[],"level":4,"position":0,"setsize":36,"posinset":36}],"level":3,"position":0,"setsize":9,"posinset":7},{"name":"sectionhead","id":"roletypestructuresectionhead","children":[{"name":"columnheader (*)","id":"roletypestructuresectionheadcolumnheader","children":[],"level":4,"position":0,"setsize":4,"posinset":1},{"name":"heading","id":"roletypestructuresectionheadheading","children":[],"level":4,"position":0,"setsize":4,"posinset":2},{"name":"rowheader (*)","id":"roletypestructuresectionheadrowheader","children":[],"level":4,"position":0,"setsize":4,"posinset":3},{"name":"tab (*)","id":"roletypestructuresectionheadtab","children":[],"level":4,"position":0,"setsize":4,"posinset":4}],"level":3,"position":0,"setsize":9,"posinset":8},{"name":"separator (*)","id":"roletypestructureseparator","children":[],"level":3,"position":0,"setsize":9,"posinset":9}],"level":2,"position":0,"setsize":3,"posinset":1},{"name":"widget","id":"roletypewidget","children":[{"name":"command","id":"roletypewidgetcommand","children":[{"name":"button","id":"roletypewidgetcommandbutton","children":[],"level":4,"position":0,"setsize":3,"posinset":1},{"name":"link","id":"roletypewidgetcommandlink","children":[],"level":4,"position":0,"setsize":3,"posinset":2},{"name":"menuitem","id":"roletypewidgetcommandmenuitem","children":[{"name":"menuitemcheckbox","id":"roletypewidgetcommandmenuitemmenuitemcheckbox","children":[{"name":"menuitemradio","id":"roletypewidgetcommandmenuitemmenuitemcheckboxmenuitemradio","children":[],"level":6,"position":0,"setsize":1,"posinset":1}],"level":5,"position":0,"setsize":1,"posinset":1}],"level":4,"position":0,"setsize":3,"posinset":3}],"level":3,"position":0,"setsize":9,"posinset":1},{"name":"composite","id":"roletypewidgetcomposite","children":[{"name":"grid (*)","id":"roletypewidgetcompositegrid","children":[{"name":"treegrid (*)","id":"roletypewidgetcompositegridtreegrid","children":[],"level":5,"position":0,"setsize":1,"posinset":1}],"level":4,"position":0,"setsize":4,"posinset":1},{"name":"select (*)","id":"roletypewidgetcompositeselect","children":[{"name":"listbox","id":"roletypewidgetcompositeselectlistbox","children":[],"level":5,"position":0,"setsize":4,"posinset":1},{"name":"menu","id":"roletypewidgetcompositeselectmenu","children":[{"name":"menubar","id":"roletypewidgetcompositeselectmenumenubar","children":[],"level":6,"position":0,"setsize":1,"posinset":1}],"level":5,"position":0,"setsize":4,"posinset":2},{"name":"radiogroup","id":"roletypewidgetcompositeselectradiogroup","children":[],"level":5,"position":0,"setsize":4,"posinset":3},{"name":"tree","id":"roletypewidgetcompositeselecttree","children":[{"name":"treegrid (*)","id":"roletypewidgetcompositeselecttreetreegrid","children":[],"level":6,"position":0,"setsize":1,"posinset":1}],"level":5,"position":0,"setsize":4,"posinset":4}],"level":4,"position":0,"setsize":4,"posinset":2},{"name":"spinbutton (*)","id":"roletypewidgetcompositespinbutton","children":[],"level":4,"position":0,"setsize":4,"posinset":3},{"name":"tablist","id":"roletypewidgetcompositetablist","children":[],"level":4,"position":0,"setsize":4,"posinset":4}],"level":3,"position":0,"setsize":9,"posinset":2},{"name":"gridcell (*)","id":"roletypewidgetgridcell","children":[{"name":"columnheader (*)","id":"roletypewidgetgridcellcolumnheader","children":[],"level":4,"position":0,"setsize":2,"posinset":1},{"name":"rowheader (*)","id":"roletypewidgetgridcellrowheader","children":[],"level":4,"position":0,"setsize":2,"posinset":2}],"level":3,"position":0,"setsize":9,"posinset":3},{"name":"input","id":"roletypewidgetinput","children":[{"name":"checkbox","id":"roletypewidgetinputcheckbox","children":[{"name":"switch","id":"roletypewidgetinputcheckboxswitch","children":[],"level":5,"position":0,"setsize":1,"posinset":1}],"level":4,"position":0,"setsize":7,"posinset":1},{"name":"combobox","id":"roletypewidgetinputcombobox","children":[],"level":4,"position":0,"setsize":7,"posinset":2},{"name":"option","id":"roletypewidgetinputoption","children":[{"name":"treeitem (*)","id":"roletypewidgetinputoptiontreeitem","children":[],"level":5,"position":0,"setsize":1,"posinset":1}],"level":4,"position":0,"setsize":7,"posinset":3},{"name":"radio","id":"roletypewidgetinputradio","children":[],"level":4,"position":0,"setsize":7,"posinset":4},{"name":"slider (*)","id":"roletypewidgetinputslider","children":[],"level":4,"position":0,"setsize":7,"posinset":5},{"name":"spinbutton (*)","id":"roletypewidgetinputspinbutton","children":[],"level":4,"position":0,"setsize":7,"posinset":6},{"name":"textbox","id":"roletypewidgetinputtextbox","children":[{"name":"searchbox","id":"roletypewidgetinputtextboxsearchbox","children":[],"level":5,"position":0,"setsize":1,"posinset":1}],"level":4,"position":0,"setsize":7,"posinset":7}],"level":3,"position":0,"setsize":9,"posinset":4},{"name":"progressbar (*)","id":"roletypewidgetprogressbar","children":[],"level":3,"position":0,"setsize":9,"posinset":5},{"name":"row (*)","id":"roletypewidgetrow","children":[],"level":3,"position":0,"setsize":9,"posinset":6},{"name":"scrollbar (*)","id":"roletypewidgetscrollbar","children":[],"level":3,"position":0,"setsize":9,"posinset":7},{"name":"separator (*)","id":"roletypewidgetseparator","children":[],"level":3,"position":0,"setsize":9,"posinset":8},{"name":"tab (*)","id":"roletypewidgettab","children":[],"level":3,"position":0,"setsize":9,"posinset":9}],"level":2,"position":0,"setsize":3,"posinset":2},{"name":"window","id":"roletypewindow","children":[{"name":"dialog","id":"roletypewindowdialog","children":[{"name":"alertdialog (*)","id":"roletypewindowdialogalertdialog","children":[],"level":4,"position":0,"setsize":1,"posinset":1}],"level":3,"position":0,"setsize":1,"posinset":1}],"level":2,"position":0,"setsize":3,"posinset":3}],"level":1,"position":0,"setsize":1}
      // The following code is based on https://bl.ocks.org/mbostock/e9ba78a2c1070980d1b530800ce7fa2b
      // Released under the GNU General Public License, version 3, https://opensource.org/licenses/GPL-3.0
      // Copyright (c) 2020, M. Bostock
      // Modifications Copyright (c) 2020 P. Krautzberger

      var svg = d3.select('svg'),
        width = +svg.attr('width'),
        height = +svg.attr('height'),
        g = svg.append('g').attr('transform', 'translate(40,0)');

      var tree = d3.tree().size([height - 400, width - 160]);

      var cluster = d3.cluster().size([height, width - 160]);

      var stratify = d3.stratify().parentId(function (d) {
        return d.id.substring(0, d.id.lastIndexOf('.'));
      });

      const root = d3
        .hierarchy(data)
        .sort(
          (a, b) =>
            d3.descending(a.height, b.height) ||
            d3.ascending(a.data.name, b.data.name)
        );

      //   cluster(root);
      tree(root);

      var link = g
        .selectAll('.link')
        .data(root.descendants().slice(1))
        .enter()
        .append('path')
        .attr('class', 'link')
        .attr('d', diagonal);

      var node = g
        .selectAll('.node')
        .data(root.descendants())
        .enter()
        .append('g')
        .attr(
          'class',
          (d) => 'node' + (d.children ? ' node--internal' : ' node--leaf')
        )
        .attr('id', (d) => d.data.id)
        .attr('role', 'treeitem')
        .attr('aria-label', (d) => d.data.name)
        .attr('aria-posinset', (d) => d.data.posinset)
        .attr('aria-setsize', (d) => d.data.setsize)
        .attr('aria-level', (d) => d.data.level)
        .attr('aria-owns', (d) =>
          d.children ? d.children.map((child) => child.data.id).join(' ') : ''
        )
        .attr('transform', (d) => 'translate(' + d.y + ',' + d.x + ')');

      node.append('circle').attr('r', 2.5);

      node
        .append('text')
        .attr('dy', (d) => (d.children ? '-1em' : '0.3em'))
        // .attr('dx', d => d.children ? d.data.name.length*4+'px': 0)
        .attr('x', (d) => (d.children ? d.data.name.length * 2 : 8))
        .style('text-anchor', function (d) {
          return d.children ? 'end' : 'start';
        })
        .text((d) => d.data.name);

      function diagonal(d) {
        return (
          'M' +
          d.y +
          ',' +
          d.x +
          'C' +
          (d.parent.y + 100) +
          ',' +
          d.x +
          ' ' +
          (d.parent.y + 100) +
          ',' +
          d.parent.x +
          ' ' +
          d.parent.y +
          ',' +
          d.parent.x
        );
      }
      addTreewalker(
        document.querySelector('svg'),
        document.querySelector('svg [aria-owns]')
      );

      d3.selectAll('input').on('change', changed);

      var timeout = setTimeout(function () {
        d3.select('input[value="tree"]')
          .property('checked', true)
          .dispatch('change');
      }, 1000);

      function changed() {
        timeout = clearTimeout(timeout);
        (this.value === 'tree' ? tree : cluster)(root);
        var t = d3.transition().duration(750);
        node.transition(t).attr('transform', function (d) {
          return 'translate(' + d.y + ',' + d.x + ')';
        });
        link.transition(t).attr('d', diagonal);
      }
    </script>
  </body>
</html>
